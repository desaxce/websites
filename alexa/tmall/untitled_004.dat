KISSY.add("mui/storage",function(e,t,n,r,o,a){var i={};var c=0;var u=function(t){var n=this;t=t||{};t.token=+new Date+o.getRndStr(8);var a=t.proxy||r.PROXY;switch(a){case"tmall":a=r.PROXY_TMALL;break;case"taobao":a=r.PROXY_TAOBAO;break;case"common":a=r.PROXY;break}a=o.fm("{0}{1}{2}={3}",a,a.indexOf("?")>-1?"&":"?",r.XD_TOKEN,t.token);t.proxy=a;t.prefix=t.prefix||"";n._opt=e.merge(i,t);n.init()};e.augment(u,{init:function(){var t=this;t.setConf(r.K.CALLBACK_LIST,{});t.setConf(r.K.CACHED_ACTION_LIST,[]);t.setConf(r.K.PROXY_READY,false);var n=t.getConf(r.K.CALLBACK_LIST);var i=t.getConf(r.K.CACHED_ACTION_LIST);var u=document.createElement("iframe");var s=u.style;s.display="none";var f=-1;function d(s){var f=new a({target:u.contentWindow,token:t.getConf(r.K.TOKEN),iframeTimeout:s,timeout:t.getConf(r.K.XD_TIMEOUT),receive:function(e){var t=n[e.c];if(t){t(e.v);try{delete n[e.c]}catch(r){}}}});t.setConf(r.K.XD,f);function d(){t.setConf(r.K.PROXY_READY,true);e.each(i,function(e){f.send(e,"*")});t.setConf(r.K.CACHED_ACTION_LIST,[]);var n=t.getConf(r.K.ONLOAD);n&&n()}if(s){d()}else{if(window.postMessage){var m=false;var l=0;var _=setInterval(function(){++l;o.log(l,m);if(m||l>30){clearInterval(_);d();return}var e="token"+ ++c;n[e]=function(e){m=!!e};f.send({m:"connect",c:e},"*",true)},50)}else{setTimeout(d,600)}}}f=setTimeout(function(){f=0;d(true)},t.getConf(r.K.IFRAME_TIMEOUT)||r.TIMEOUT_STORAGE);function m(e){o.log("storage proxy loaded");clearTimeout(f);if(!f){return}d(false)}if(u.attachEvent){u.attachEvent("onload",m)}else{u.onload=m}u.src=t.getConf(r.K.PROXY);document.body.appendChild(u)},send:function(t){var n=this;var o=n.getConf(r.K.CALLBACK_LIST);var a=n.getConf(r.K.CACHED_ACTION_LIST);var i=n.getConf(r.K.PROXY_READY);var u=n.getConf(r.K.PREFIX);t.p=u;if(e.isFunction(t.success)){var s="token"+ ++c;t.c=s;o[s]=t.success;try{delete t.success}catch(f){}}if(!i){a.push(t);return}var d=n.getConf(r.K.XD);d&&d.send(t)},get:function(e){e=e||{};e.m="get";this.send(e);Math.random()<r.SAM_PV&&o.sendLog(r.ARR.ST_GET)},set:function(e){e=e||{};e.m="set";this.send(e);Math.random()<r.SAM_PV&&o.sendLog(r.ARR.ST_SET)},remove:function(e){e=e||{};e.m="remove";this.send(e);Math.random()<r.SAM_PV&&o.sendLog(r.ARR.ST_RM)},clear:function(e){e=e||{};e.m="clear";this.send(e);Math.random()<r.SAM_PV&&o.sendLog(r.ARR.ST_CL)},getConf:function(e){return this._opt[e]},setConf:function(e,t){this._opt[e]=t}});return u},{requires:["event","json","mui/storage/conf","mui/storage/util","mui/storage/xd"]});KISSY.add("mui/storage/conf",function(){var e=location.href.indexOf("if-debug=1")>-1;var t=location.href.indexOf("if-debug-log=1")>-1;var r="http://gm.mmstat.com";var n="http://log.mmstat.com/ued.1.1.2?type=9&_gm:id=storage&v=1.1";var a={DEBUG:e,DEBUG_LOG:t,SAM_PV:1/1e3,TIMEOUT_STORAGE:3*1e3,PROXY:e?"http://cdnprepub.tms.taobao.com/go/market/main/mui/storage/stp-1_1_2.php":"http://www.tmall.com/go/market/main/mui/storage/stp-1_1_2.php",PROXY_TMALL:e?"http://cdnprepub.tms.taobao.com/go/act/stp-tm-1_1_0.php":"http://www.tmall.com/go/act/stp-tm-1_1_0.php",PROXY_TAOBAO:e?"http://cdnprepub.tms.taobao.com/go/act/stp-tb-1_1_0.php":"http://www.tmall.com/go/act/stp-tb-1_1_0.php",XD_TOKEN:"__mui_xd_token",UID_FROM:"__mui_xd_from",UID_TO:"__mui_xd_to",M:{G:n+"&t=g",P:n+"&t=p"},ARR:{ST_SET:r+"/tmallbrand.999.5",ST_GET:r+"/tmallbrand.999.6",ST_RM:r+"/tmallbrand.999.7",ST_CL:r+"/tmallbrand.999.8",ST_TMO:r+"/tmallbrand.999.10"},K:{ONLOAD:"onload",PROXY:"proxy",PREFIX:"prefix",XD_TIMEOUT:"xdTimeout",IFRAME_TIMEOUT:"iframeTimeout",IFRAME:"iframe",TOKEN:"token",XD:"xd",CALLBACK_LIST:"callbackList",CACHED_ACTION_LIST:"cachedActionList",PROXY_READY:"proxyReady"}};return a});KISSY.add("mui/storage/util",function(e,t){var n={log:function(){if(!t.DEBUG_LOG){return}if(window.console&&window.console.log&&window.console.log.apply){window.console.log.apply(window.console,arguments)}},fm:function(){if(arguments.length==0){return""}else if(arguments.length==1){return arguments[0]}var e=arguments[0],t;for(t=1;t<arguments.length;++t){var n=new RegExp("\\{"+(t-1)+"\\}","g");e=e.replace(n,arguments[t])}return e}};var r=n;r.sendLog=function(e){r.send(r.fm(t.M.G,encodeURIComponent(location.href)));r.send(e)};r.send=function(e){if(!e){return}var t="__st_"+ +new Date+Math.random();var n=new Image;window[t]=n;n.src=r.fm("{0}{1}r{2}=1",e,e.indexOf("?")>-1?"&":"?",+new Date);n.onload=function(){window[t]=null}};var o="1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";r.getRndStr=function(e){var t=[];var n=o.length,r;for(var a=0;a<e;++a){r=o.charAt(Math.floor(Math.random()*n));t.push(r)}return t.join("")};return r},{requires:["mui/storage/conf"]});KISSY.add("mui/storage/xd",function(e,t,n,r,a){var o=0;var i=document.domain;var s="receive";var u="token";var c="target";var f="timeout";var d="iframeTimeout";var m=10;var v=10;var l=3*1e3;var g=window;var _=g.postMessage;var p={};var h=[];function T(){if(_){if(g.addEventListener){addEventListener("message",A,false)}else if(g.attachEvent){attachEvent("onmessage",A)}}else{O.onMessage(A)}}var O={uid:0,hid:-1,q:[],tm:0,postMessage:function(e,t,n){var r=++O.uid;var a=O.q;var o={name:+new Date+""+r+"^"+i+"&"+t,uid:r,target:e};a.push(o);if(!O.tm){O.tm=setInterval(function(){var e=O.q;if(e.length===0||e[0].uid===O.hid){return}var t=e[0];O.hid=t.uid;t.target.name=t.name},v)}},onMessage:function(e){var t="";var n=/^(\d+?)\^(.+?)&(.*?)$/;function r(){var r=g.name;if(r!==t){O.q.shift();t=r;var a=n.exec(r);if(!a){return}var o={origin:a[2],data:a[3]};e&&e(o)}}setInterval(r,m)}};function A(t){var a={};try{a=n.parse(t.data)}catch(o){return}var i=a[r.XD_TOKEN];e.each(h,function(e){if(i===e.get(u)&&r.UID_FROM in a&&r.UID_TO in a){var t=a[r.UID_TO];if(t){var n=p[t];clearTimeout(n);p[t]=0;if(!n){return}}e.get(s)(a)}})}T();function w(e){var t=this;t._opt=e;h.push(t)}e.augment(w,{send:function(t,s,m){if(!e.isObject(t)){return}var v=this;var g=v.get(c);var h=v.get(f)||l;var T=++o;s=s||"*";t[r.XD_TOKEN]=v.get(u);t[r.UID_TO]=t[r.UID_FROM]||0;t[r.UID_FROM]=m?0:T;var w=n.stringify(t);function I(){_&&O.q.shift();var e={};e.origin="*";var a={};a.c=t.c||"";a[r.XD_TOKEN]=t[r.XD_TOKEN]||"";a[r.UID_FROM]=0;a[r.UID_TO]=0;e.data=n.stringify(a);A(e)}if(!m){p[T]=setTimeout(function(){a.log(i,"timeout",T);p[T]=0;I();Math.random()<r.SAM_PV&&a.sendLog(r.ARR.ST_TMO)},h)}if(v.get(d)){I()}else{if(_){g.postMessage(w,s)}else{O.postMessage(g,w,s)}}},get:function(e){return this._opt[e]},set:function(e,t){this._opt[e]=t}});return w},{requires:["event","json","mui/storage/conf","mui/storage/util"]});